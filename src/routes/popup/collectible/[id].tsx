import { concatGatewayURL } from "~gateways/utils";
import { Section, Spacer, Text } from "@arconnect/components";
import { useEffect, useMemo, useState } from "react";
import { AnimatePresence } from "framer-motion";
import { Link } from "../token/[id]";
import TokenLoading from "~components/popup/asset/Loading";
import Thumbnail from "~components/popup/asset/Thumbnail";
import Skeleton from "~components/Skeleton";
import browser from "webextension-polyfill";
import Title from "~components/popup/Title";
import styled from "styled-components";
import { FULL_HISTORY, useGateway } from "~gateways/wayfinder";
import HeadV2 from "~components/popup/HeadV2";
import type { CommonRouteProps } from "~wallets/router/router.types";
import placeholderUrl from "url:/assets/placeholder.png";
import { useStorage } from "@plasmohq/storage/hook";
import { getTagValue, type TokenInfoWithBalance } from "~tokens/aoTokens/ao";
import { ExtensionStorage } from "~utils/storage";
import { gql } from "~gateways/api";

export interface CollectibleViewParams {
  id: string;
}

export type CollectibleViewProps = CommonRouteProps<CollectibleViewParams>;

export function CollectibleView({ params: { id } }: CollectibleViewProps) {
  // load state
  const [loading, setLoading] = useState(false);
  const [description, setDescription] = useState<string>("");
  const [aoTokens] = useStorage<TokenInfoWithBalance[]>(
    {
      key: "ao_tokens",
      instance: ExtensionStorage
    },
    []
  );
  const token = useMemo(() => {
    return aoTokens.find((t) => t.processId === id);
  }, [aoTokens, id]);

  // price
  const [price, setPrice] = useState<number>();

  const defaultGateway = useGateway(FULL_HISTORY);

  async function getCollectionDescription() {
    setLoading(true);
    try {
      const { data } = await gql(
        `query ($id: ID!) {
          transaction (id: $id) {
            tags {
              name
              value
            }
          }
        }`,
        { id },
        defaultGateway
      );

      const description = getTagValue(
        "Description",
        data.transaction.tags as any[]
      );
      setDescription(description);
    } catch {
      //
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    if (!id || description) return;
    getCollectionDescription();
  }, [id]);

  return (
    <>
      <HeadV2 title={browser.i18n.getMessage("collectible")} />
      <Spacer y={0.75} />
      <Thumbnail
        src={`${concatGatewayURL(defaultGateway)}/${id}`}
        fallback={placeholderUrl}
      />
      <Section>
        <Title heading noMargin>
          {token?.Name || token?.Ticker || <Skeleton width="6rem" />}
        </Title>
        {price && (
          <Price noMargin>
            {price}
            <span>AR</span>
          </Price>
        )}
        <Spacer y={1} />
        <Description>
          {(!loading && (
            <>{description || browser.i18n.getMessage("no_description")}</>
          )) ||
            new Array(5)
              .fill("")
              .map((_, i) => (
                <Skeleton
                  addMargin
                  height="1rem"
                  width={i === 4 ? "80%" : "100%"}
                  key={i}
                />
              ))}
        </Description>
        <Spacer y={1} />
        <Title noMargin>{browser.i18n.getMessage("info_title")}</Title>
        <Spacer y={0.6} />
        {(!loading && (
          <>
            <Link href={`https://bazar.arweave.dev/#/asset/${id}`}>
              <BazarIcon />
              Bazar
            </Link>
            <Spacer y={0.22} />
            <Link href={`https://www.ao.link/#/entity/${id}`}>
              <AoLinkIcon />
              AO Link
            </Link>
            <Spacer y={0.22} />
            <Link href={`https://viewblock.io/arweave/tx/${id}`}>
              <ViewBlockIcon />
              Viewblock
            </Link>
          </>
        )) ||
          new Array(4)
            .fill("")
            .map((_, i) => (
              <Skeleton addMargin height="1rem" width="6.8rem" key={i} />
            ))}
      </Section>
      <AnimatePresence>{loading && <TokenLoading />}</AnimatePresence>
    </>
  );
}

const Price = styled(Text)`
  font-size: 1.075rem;
  font-weight: 600;

  span {
    font-size: 0.63em;
  }
`;

const Description = styled(Text).attrs({
  noMargin: true
})`
  font-size: 0.9rem;
  text-align: justify;
`;

const BazarIcon = () => (
  <svg
    width="1900"
    height="1900"
    viewBox="0 0 1900 1900"
    fill="none"
    xmlns="http://www.w3.org/2000/svg"
  >
    <g clipPath="url(#clip0_1849_336)">
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M930.935 376.467L782.693 559.057L904.96 748.959L1066.06 748.958L1190.79 562.462L930.935 376.467ZM1226.92 508.444L951.944 311.626C933.455 298.393 907.862 301.838 893.53 319.491L745.69 501.585L634.02 328.141C617.287 302.153 579.427 301.774 562.178 327.42L277.268 751.019C239.34 759.531 211.001 793.413 211.001 833.916L211 1204.55C211 1237.39 232.07 1265.31 261.427 1275.52C230.109 1309.55 211 1355.12 211 1405.07C211 1509.87 295.13 1595.42 399.642 1595.42C504.155 1595.42 588.285 1509.87 588.285 1405.07C588.285 1357.12 570.678 1313.21 541.567 1279.67H1358.43C1329.32 1313.21 1311.72 1357.12 1311.72 1405.07C1311.72 1509.87 1395.85 1595.42 1500.36 1595.42C1604.87 1595.42 1689 1509.87 1689 1405.07C1689 1355.44 1670.13 1310.12 1639.17 1276.16C1668.09 1266.78 1689 1239.61 1689 1207.56V869.217C1689 803.888 1636.92 750.726 1572.02 749.002L1398.35 423.984C1375.24 380.721 1314.36 377.711 1287.09 418.483L1226.92 508.444ZM1568.97 813.916C1568.9 813.916 1568.83 813.916 1568.76 813.916H295.947C284.902 813.916 275.949 822.87 275.949 833.916L275.948 1204.55C275.948 1210.16 280.497 1214.71 286.108 1214.71H1616.9C1620.85 1214.71 1624.05 1211.51 1624.05 1207.56V869.217C1624.05 838.744 1599.41 814.027 1568.97 813.916ZM1498.35 748.958H1144.19L1341.07 454.598L1498.35 748.958ZM399.642 1279.67C467.629 1279.67 523.337 1335.48 523.337 1405.07C523.337 1474.65 467.63 1530.46 399.642 1530.46C331.655 1530.46 275.948 1474.65 275.948 1405.07C275.948 1335.48 331.656 1279.67 399.642 1279.67ZM356.929 748.959H827.711L597.461 391.34L356.929 748.959ZM1500.36 1279.67C1432.37 1279.67 1376.66 1335.48 1376.66 1405.07C1376.66 1474.65 1432.37 1530.46 1500.36 1530.46C1568.35 1530.46 1624.05 1474.65 1624.05 1405.07C1624.05 1335.48 1568.35 1279.67 1500.36 1279.67Z"
        fill="currentColor"
      />
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M399.642 1562.94C313.393 1562.94 243.474 1492.26 243.474 1405.07C243.474 1317.88 313.393 1247.19 399.642 1247.19C485.892 1247.19 555.811 1317.88 555.811 1405.07C555.811 1492.26 485.892 1562.94 399.642 1562.94ZM523.337 1405.07C523.337 1335.48 467.628 1279.67 399.642 1279.67C331.656 1279.67 275.948 1335.48 275.948 1405.07C275.948 1474.65 331.655 1530.46 399.642 1530.46C467.629 1530.46 523.337 1474.65 523.337 1405.07Z"
        fill="currentColor"
      />
      <path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M1500.36 1562.94C1414.1 1562.94 1344.19 1492.26 1344.19 1405.07C1344.19 1317.88 1414.1 1247.19 1500.36 1247.19C1586.61 1247.19 1656.53 1317.88 1656.53 1405.07C1656.53 1492.26 1586.61 1562.94 1500.36 1562.94ZM1500.36 1279.67C1432.37 1279.67 1376.66 1335.48 1376.66 1405.07C1376.66 1474.65 1432.37 1530.46 1500.36 1530.46C1568.35 1530.46 1624.05 1474.65 1624.05 1405.07C1624.05 1335.48 1568.35 1279.67 1500.36 1279.67Z"
        fill="currentColor"
      />
    </g>
    <defs>
      <clipPath id="clip0_1849_336">
        <rect
          width="1478"
          height="1293"
          fill="white"
          transform="translate(211 303)"
        />
      </clipPath>
    </defs>
  </svg>
);

const ViewBlockIcon = () => (
  <svg width="30" height="30" viewBox="0 0 100 100" version="1.1">
    <g transform="matrix(1, 0, 0, -1, -26, 126)">
      <g transform="scale(0.1)">
        <path
          d="m 1260,773.418 h -85.18 C 1167.79,990.469 990.469,1167.78 773.418,1174.81 V 1260 h -26.836 v -85.19 C 529.531,1167.78 352.207,990.469 345.176,773.418 H 260 v -26.836 h 85.176 C 352.207,529.531 529.531,352.219 746.582,345.191 V 260 h 26.836 v 85.191 c 217.051,7.028 394.372,184.34 401.402,401.391 H 1260 v 26.836"
          fill="#ffffff"
        ></path>
        <path
          d="M 452.117,942.512 760,764.758 1067.87,942.512 760,1120.27 452.117,942.512"
          fill="#81d6f7"
        ></path>
        <path
          d="M 1075.33,929.602 767.449,751.848 V 396.34 l 307.881,177.742 v 355.52"
          fill="#316bbd"
        ></path>
        <path
          d="M 444.668,574.082 752.539,396.34 V 751.848 L 444.668,929.602 v -355.52"
          fill="#469fde"
        ></path>
        <path
          d="m 760,785.586 c -4.441,0 -8.047,3.391 -8.047,7.844 v 0.398 c 0,4.442 3.606,8.035 8.047,8.035 4.441,0 8.047,-3.593 8.047,-8.035 0,-4.453 -3.606,-8.242 -8.047,-8.242"
          fill="#316bbd"
        ></path>
        <path
          d="m 760,1040.56 c -4.441,0 -8.047,3.59 -8.047,8.05 v 0.82 c 0,4.45 3.606,8.05 8.047,8.05 4.441,0 8.047,-3.6 8.047,-8.05 v -0.82 c 0,-4.46 -3.606,-8.05 -8.047,-8.05 z m 0,-42.599 c -4.441,0 -8.047,3.589 -8.047,8.049 v 0.83 c 0,4.44 3.606,8.04 8.047,8.04 4.441,0 8.047,-3.6 8.047,-8.04 v -0.83 c 0,-4.46 -3.606,-8.049 -8.047,-8.049 z m 0,-42.609 c -4.441,0 -8.047,3.593 -8.047,8.046 v 0.84 c 0,4.446 3.606,8.035 8.047,8.035 4.441,0 8.047,-3.589 8.047,-8.035 v -0.84 c 0,-4.453 -3.606,-8.046 -8.047,-8.046 z m 0,-42.598 c -4.441,0 -8.047,3.594 -8.047,8.047 v 0.832 c 0,4.441 3.606,8.047 8.047,8.047 4.441,0 8.047,-3.606 8.047,-8.047 v -0.832 c 0,-4.453 -3.606,-8.047 -8.047,-8.047 z m 0,-42.609 c -4.441,0 -8.047,3.593 -8.047,8.046 v 0.84 c 0,4.446 3.606,8.039 8.047,8.039 4.441,0 8.047,-3.593 8.047,-8.039 v -0.84 c 0,-4.453 -3.606,-8.046 -8.047,-8.046 z m 0,-42.594 c -4.441,0 -8.047,3.594 -8.047,8.047 v 0.828 c 0,4.441 3.606,8.039 8.047,8.039 4.441,0 8.047,-3.598 8.047,-8.039 v -0.828 c 0,-4.453 -3.606,-8.047 -8.047,-8.047"
          fill="#316bbd"
        ></path>
        <path
          d="m 760,1083.36 c -4.441,0 -8.047,3.4 -8.047,7.84 v 0.4 c 0,4.45 3.606,8.05 8.047,8.05 4.441,0 8.047,-3.6 8.047,-8.05 0,-4.44 -3.606,-8.24 -8.047,-8.24"
          fill="#316bbd"
        ></path>
        <path
          d="m 727.371,729.27 c -2.793,0 -5.516,1.46 -6.988,4.07 -2.199,3.867 -0.852,8.769 3.015,10.969 3.86,2.214 8.957,0.933 11.133,-2.922 2.199,-3.86 1.028,-8.672 -2.843,-10.867 l -0.34,-0.2 c -1.258,-0.711 -2.625,-1.05 -3.977,-1.05"
          fill="#81d6f7"
        ></path>
        <path
          d="m 690.48,707.969 c -2.777,0 -5.492,1.445 -6.972,4.023 -2.231,3.86 -0.903,8.77 2.945,10.988 l 0.727,0.418 c 3.855,2.215 8.777,0.887 10.984,-2.96 2.227,-3.844 0.899,-8.766 -2.949,-10.973 l -0.723,-0.422 c -1.269,-0.73 -2.656,-1.074 -4.012,-1.074 z M 653.586,686.66 c -2.785,0 -5.488,1.445 -6.977,4.031 -2.222,3.852 -0.894,8.774 2.954,10.989 l 0.718,0.41 c 3.852,2.226 8.782,0.898 10.989,-2.949 2.214,-3.848 0.886,-8.77 -2.957,-10.989 l -0.723,-0.41 c -1.262,-0.73 -2.649,-1.082 -4.004,-1.082 z m -36.898,-21.301 c -2.75,0 -5.438,1.418 -6.942,3.977 -2.246,3.828 -0.969,8.762 2.859,11.008 l 0.723,0.418 c 3.82,2.265 8.762,0.968 11.008,-2.864 2.246,-3.828 0.969,-8.757 -2.859,-11.003 l -0.723,-0.43 c -1.274,-0.75 -2.68,-1.106 -4.066,-1.106 z m -36.883,-21.296 c -2.785,0 -5.496,1.445 -6.985,4.035 -2.215,3.843 -0.886,8.765 2.961,10.972 l 0.723,0.422 c 3.848,2.227 8.769,0.899 10.976,-2.949 2.227,-3.855 0.899,-8.77 -2.949,-10.984 l -0.722,-0.422 c -1.27,-0.723 -2.649,-1.074 -4.004,-1.074 z m -36.907,-21.297 c -2.769,0 -5.488,1.445 -6.968,4.019 -2.219,3.86 -0.903,8.774 2.957,10.988 l 0.722,0.418 c 3.86,2.219 8.758,0.879 10.977,-2.957 2.227,-3.847 0.898,-8.769 -2.949,-10.976 l -0.723,-0.418 c -1.269,-0.735 -2.644,-1.074 -4.016,-1.074 z m -36.89,-21.313 c -2.778,0 -5.488,1.445 -6.977,4.035 -2.222,3.848 -0.894,8.77 2.949,10.977 l 0.723,0.422 c 3.86,2.234 8.774,0.894 10.988,-2.949 2.227,-3.86 0.899,-8.77 -2.949,-10.989 l -0.722,-0.422 c -1.27,-0.718 -2.657,-1.074 -4.012,-1.074"
          fill="#81d6f7"
        ></path>
        <path
          d="m 469.492,580.371 c -2.781,0 -5.488,1.445 -6.98,4.024 -2.219,3.847 -0.903,8.769 2.949,10.996 3.848,2.214 8.934,0.996 11.16,-2.852 2.227,-3.84 1.082,-8.66 -2.766,-10.891 l -0.347,-0.195 c -1.274,-0.73 -2.649,-1.082 -4.016,-1.082"
          fill="#81d6f7"
        ></path>
        <path
          d="m 792.617,729.27 c -1.347,0 -2.715,0.339 -3.965,1.05 -3.867,2.192 -5.39,7.207 -3.191,11.067 2.184,3.867 6.91,5.312 10.789,3.117 l 0.352,-0.195 c 3.859,-2.2 5.214,-7.102 3.007,-10.969 -1.472,-2.61 -4.199,-4.07 -6.992,-4.07"
          fill="#469fde"
        ></path>
        <path
          d="m 829.512,707.969 c -1.36,0 -2.742,0.344 -4.004,1.074 l -0.723,0.422 c -3.847,2.207 -5.176,7.129 -2.961,10.973 2.207,3.847 7.141,5.175 10.989,2.96 l 0.722,-0.418 c 3.848,-2.218 5.176,-7.128 2.949,-10.988 -1.484,-2.578 -4.187,-4.023 -6.972,-4.023 z m 36.894,-21.309 c -1.355,0 -2.746,0.352 -4.004,1.082 l -0.722,0.41 c -3.848,2.219 -5.176,7.141 -2.957,10.989 2.207,3.847 7.136,5.175 10.984,2.949 l 0.723,-0.41 c 3.847,-2.215 5.175,-7.137 2.949,-10.989 -1.484,-2.586 -4.191,-4.031 -6.973,-4.031 z m 36.895,-21.301 c -1.375,0 -2.781,0.356 -4.063,1.106 l -0.722,0.43 c -3.828,2.246 -5.11,7.175 -2.864,11.003 2.258,3.832 7.168,5.129 11.008,2.864 l 0.723,-0.418 c 3.828,-2.246 5.105,-7.18 2.859,-11.008 -1.492,-2.559 -4.179,-3.977 -6.941,-3.977 z m 36.894,-21.296 c -1.367,0 -2.746,0.351 -4.011,1.074 l -0.723,0.422 c -3.852,2.214 -5.18,7.129 -2.949,10.984 2.215,3.848 7.129,5.176 10.972,2.949 l 0.727,-0.422 c 3.855,-2.207 5.184,-7.129 2.957,-10.972 -1.484,-2.59 -4.199,-4.035 -6.973,-4.035 z m 36.895,-21.297 c -1.36,0 -2.742,0.339 -4.016,1.074 l -0.719,0.418 c -3.847,2.207 -5.175,7.129 -2.953,10.976 2.219,3.836 7.129,5.176 10.989,2.957 l 0.722,-0.418 c 3.848,-2.214 5.176,-7.128 2.95,-10.988 -1.485,-2.574 -4.2,-4.019 -6.973,-4.019 z m 36.89,-21.313 c -1.35,0 -2.74,0.356 -4,1.074 l -0.72,0.422 c -3.85,2.219 -5.18,7.129 -2.96,10.989 2.22,3.843 7.13,5.183 10.99,2.949 l 0.72,-0.422 c 3.85,-2.207 5.17,-7.129 2.95,-10.977 -1.49,-2.59 -4.19,-4.035 -6.98,-4.035"
          fill="#469fde"
        ></path>
        <path
          d="m 1050.5,580.371 c -1.39,0 -2.79,0.359 -4.08,1.121 -3.83,2.258 -5.27,7.297 -3.01,11.125 2.27,3.821 7.02,5.188 10.85,2.93 l 0.34,-0.203 c 3.83,-2.258 5.1,-7.192 2.84,-11.02 -1.51,-2.539 -4.19,-3.953 -6.94,-3.953"
          fill="#469fde"
        ></path>
      </g>
    </g>
  </svg>
);

const AoLinkIcon = () => (
  <svg
    xmlns="http://www.w3.org/2000/svg"
    width="32"
    height="7"
    viewBox="0 0 32 7"
    fill="none"
  >
    <g clip-path="url(#clip0_428_9057)">
      <path
        d="M0 6.28965H1.93604L2.33115 5.22119L1.44215 3.40088L0 6.28965Z"
        fill="black"
      />
      <path
        d="M5.13634 4.84508L2.98299 0.511963L2.33105 1.99591L4.36587 6.28948H5.83167L5.13634 4.84508Z"
        fill="black"
      />
      <path
        fill-rule="evenodd"
        clip-rule="evenodd"
        d="M8.73385 6.28947C10.3368 6.28947 11.6361 4.99008 11.6361 3.38717C11.6361 1.78427 10.3368 0.484863 8.73385 0.484863C7.13094 0.484863 5.83154 1.78427 5.83154 3.38717C5.83154 4.99008 7.13094 6.28947 8.73385 6.28947ZM8.73385 5.15027C9.70757 5.15027 10.4969 4.3609 10.4969 3.38717C10.4969 2.41345 9.70757 1.62409 8.73385 1.62409C7.76012 1.62409 6.97074 2.41345 6.97074 3.38717C6.97074 4.3609 7.76012 5.15027 8.73385 5.15027Z"
        fill="black"
      />
      <path
        d="M13.4895 5.47895H15.9561V6.05403H12.8486V0.720703H13.4895V5.47895Z"
        fill="#9EA2AA"
      />
      <path
        d="M16.9556 0.720703H20.0041V1.31045H18.7951V5.46794H20.0041V6.05403H16.9556V5.46794H18.1369V1.31045H16.9556V0.720703Z"
        fill="#9EA2AA"
      />
      <path
        d="M24.3049 6.05403H23.6536L21.6963 2.06869L21.6859 6.05403H21.0381V0.720703H21.6893L23.6467 4.69872L23.657 0.720703H24.3049V6.05403Z"
        fill="#9EA2AA"
      />
      <path
        d="M26.5446 3.57785L25.9834 4.25184V6.05403H25.3286V0.720703H25.9834V3.3251L26.4718 2.68041L27.9511 0.720703H28.7306L26.9672 3.05404L28.8483 6.05403H28.0689L26.5446 3.57785Z"
        fill="#9EA2AA"
      />
      <path
        d="M30.3032 1.93941L31.7578 0.484863M31.7578 0.484863H30.511M31.7578 0.484863V1.73162"
        stroke="black"
        stroke-width="0.484848"
      />
    </g>
    <defs>
      <clipPath id="clip0_428_9057">
        <rect width="32" height="6.30303" fill="white" />
      </clipPath>
    </defs>
  </svg>
);
